<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	   xmlns:jaxrs="http://cxf.apache.org/jaxrs"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:camel="http://camel.apache.org/schema/spring"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.2.xsd
	   http://cxf.apache.org/jaxrs http://cxf.apache.org/schemas/jaxrs.xsd
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">

  <context:annotation-config/>
  <!--context:component-scan base-package="com.pimco.techops.pint"/-->

  <!--bean id="appConfig" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"-->
  <!--context:property-placeholder location="classpath:${ENV}.properties" local-override="true" ignore-resource-not-found="true" /-->

  <!--bean id="appConfig" class="org.springframework.web.context.support.ServletContextPropertyPlaceholderConfigurer">
	<property name="searchContextAttributes" value="true" />
	<property name="searchSystemEnvironment" value="true" />
	<property name="systemPropertiesModeName" value="SYSTEM_PROPERTIES_MODE_OVERRIDE" /-->
  <bean id="appConfig" class="org.springframework.context.support.PropertySourcesPlaceholderConfigurer">
	<property name="locations">
	  <list>
		<value>classpath:common.properties</value>
		<value>classpath:${ENV}.properties</value>
	  </list>
	</property>
  </bean>

  <bean id="oraDS" class="oracle.jdbc.pool.OracleConnectionPoolDataSource" destroy-method="close">
        <property name="URL" value="${ora.jdbcUrl}" />
        <property name="user" value="${ora.user}" />
        <property name="password" value="${ora.password}" />
  </bean>

  <bean id="syb.c3p0" class="com.mchange.v2.c3p0.ComboPooledDataSource" destroy-method="close">
        <property name="driverClass" value="com.sybase.jdbc3.jdbc.SybDriver"/>
        <property name="jdbcUrl" value="${syb.jdbcUrl}" />
        <property name="user" value="${syb.user}" />
        <property name="password" value="${syb.password}" />
        <property name="preferredTestQuery" value="SELECT 1" />
        <property name="idleConnectionTestPeriod" value="300" />
        <property name="testConnectionOnCheckout" value="true" />
  </bean>

  <bean id="ETACache" class="com.pimco.techops.pint.ds.ETACache" >
	  <property name="sybDataSource" ref="syb.c3p0"/>
	  <property name="oraDataSource" ref="oraDS"/>
  </bean>

  <bean id="EventCache" class="com.pimco.techops.pint.ds.EventCache" >
	  <property name="sybDataSource" ref="syb.c3p0"/>
	  <property name="oraDataSource" ref="oraDS"/>
	  <property name="camelContext" ref="pintCC"/>
	  <property name="eTACache" ref="ETACache"/>
  </bean>

   <bean id="myRoutes" class="com.pimco.techops.pint.camelRoute" >
	</bean>

  <!-- camelContext is the Camel runtime, where we can host Camel routes -->
  <camelContext id="pintCC" xmlns="http://camel.apache.org/schema/spring">
	<!--dataFormats>
	  <json id="jacksonMapper" library="Jackson"/>
	</dataFormats-->
   <routeBuilder ref="myRoutes" />
  </camelContext>

   <bean id="jacksonMapper" class="com.pimco.techops.pint.ds.JodaObjectMapper" />
   <!--bean id="jacksonMapper" class="com.fasterxml.jackson.databind.ObjectMapper" /-->

   <bean id="jsonProvider" class="com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider">
	 <property name="mapper" ref="jacksonMapper"/>
   </bean>

   <bean id="SessionManager" class="com.pimco.techops.pint.ds.SessionManager" />
   <bean id="authenticator" class="com.pimco.techops.pint.AuthInterceptor" init-method="start" />
   <bean id="UserConfigManager" class="com.pimco.techops.pint.ds.UserConfigManager" init-method="read" />
   <bean id="ToolConfig" class="com.pimco.techops.pint.ds.ToolConfig" init-method="read" />
   <bean id="eventRestSvc" class="com.pimco.techops.pint.EventRestSvc" init-method="startCC" destroy-method="stopCC" >
	  <property name="camelContext" ref="pintCC" />
  </bean>

   <jaxrs:server id="pintRestSvr" address="/">
	<jaxrs:serviceBeans>
	  <ref bean="eventRestSvc" />
	</jaxrs:serviceBeans>

	<jaxrs:inInterceptors>
	  <ref bean="authenticator" />
	</jaxrs:inInterceptors>

	<jaxrs:providers>
	  <ref bean="jsonProvider"/>
	</jaxrs:providers>

	<jaxrs:extensionMappings>
	 <entry key="avro" value="application/avro-generic" />
	</jaxrs:extensionMappings>

   </jaxrs:server>

</beans>
